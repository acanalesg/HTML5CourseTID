<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">

    <script src="objexec.js?t=9192345775678"></script>

    <script>
      'use strict';

      var database;
      var data;
      var numItems;
      var TOTAL_ITEMS = 5001;

      function prepare(cb) {
        function fillData() {
         data = [];
         numItems = document.querySelector('input[name="numObjs"]').value || TOTAL_ITEMS;
          for (var j = 1; j <= numItems; j++) {
            data.push({ id: j });
          }
        }

        fillData();

        window.console.log('Data filled');

        var req = window.indexedDB.open('ObjectExecutor', 2.0);
        req.onupgradeneeded = function() {
          window.console.log('On upgrade needed');
          req.result.createObjectStore('theStore', {keyPath: 'id'});
        }

        req.onsuccess = function() {
          window.console.log('On success');
          database = req.result;
          var clearTrans = database.transaction('theStore', 'readwrite');
          var clearReq = clearTrans.objectStore('theStore').clear();
          clearTrans.oncomplete = cb;
        }

        req.onerror = function() {
          window.console.error('Error!!!', req.error.name);
        }
      }
    </script>

    <script>
      function run() {
        window.console.log('Running');

        prepare(function() {
            window.console.log('Prepare Cb executed');
            var progress = document.querySelector('progress');
            progress.value = 0;
            progress.max = numItems;
            document.querySelector('p').textContent = '';
            var total = 0;

            var executor = new ObjectExecutor(data, database);

            executor.onfinish = function() {
              document.querySelector('p').textContent = 'Finished!!!';
              database.close();
              window.console.log('Task finished successfully');
            }
            executor.onrecordadded = function() {
              progress.value = ++total;
            }
            executor.onerror = function() {
              window.console.error('Error while adding record');
            }

            executor.start();
        });
      }
    </script>
  </head>

  <body>
    <h1>Object Executor Pattern</h1>
    <label>Num Objs: </label><input type=number name="numObjs" size="10"></input></label><br>
    <button type="button" id="b" onclick="run()">Run</button><br>
    <progress value="0" style="width:400px"></progress>
    <p style="color: red"></p>
  </body>
</html>
